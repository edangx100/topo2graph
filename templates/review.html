<!--
    Review template - detailed view for reviewing a single topology JSON file.
    Layout: Two-column responsive grid
    - Left: JSON editor, validation messages, image preview (if available)
    - Right: Read-only nodes and links tables for quick reference

    Forms submit to:
    - /validate - re-validates edited JSON without saving
    - /approve - validates and saves to approved/ if valid
-->
{% extends "base.html" %}

{% block title %}Review: {{ filename }} - Topo2Graph{% endblock %}

{% block content %}
<!-- Back navigation link -->
<div class="mb-4">
    <a href="/" class="inline-flex items-center text-indigo-600 hover:text-indigo-800">
        <!-- Left arrow icon -->
        <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to list
    </a>
</div>

<!-- Two-column grid: editor on left, tables on right -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- LEFT COLUMN: JSON editor, validation status, and image -->
    <div class="space-y-4">
        <div class="bg-white rounded-lg shadow-md p-6">
            <!-- File name header with Neo4j status -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-gray-800">{{ filename }}</h1>
                <!--
                    NEO4J STATUS INDICATOR
                    Shows connection status to Neo4j database:
                    - connected (green): Successfully connected to Neo4j
                    - error (red): Configuration exists but connection failed
                    - not_configured (gray): NEO4J_* env vars not set
                    Hover over the badge to see the full status message.
                -->
                {% if neo4j_status.status == "connected" %}
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800" title="{{ neo4j_status.message }}">
                    <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    Neo4j connected
                </span>
                {% elif neo4j_status.status == "error" %}
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800" title="{{ neo4j_status.message }}">
                    <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Neo4j error
                </span>
                {% else %}
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600" title="{{ neo4j_status.message }}">
                    <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    Neo4j not configured
                </span>
                {% endif %}
            </div>

            <!--
                VALIDATION STATUS SECTION
                Shows one of: load_error, errors, warnings, or success message
                Errors block approval; warnings are informational only
            -->

            <!-- Load error - file couldn't be parsed -->
            {% if load_error %}
            <div class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700">
                <div class="font-medium">Load Error</div>
                <p>{{ load_error }}</p>
            </div>
            {% endif %}

            <!-- Blocking errors - must be fixed before approval -->
            {% if errors %}
            <div class="mb-4 p-4 bg-red-50 border-l-4 border-red-500">
                <div class="font-medium text-red-800 mb-2">Errors (must fix before approval)</div>
                <ul class="list-disc list-inside text-red-700 text-sm space-y-1">
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Non-blocking warnings - shown but don't prevent approval -->
            {% if warnings %}
            <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500">
                <div class="font-medium text-yellow-800 mb-2">Warnings</div>
                <ul class="list-disc list-inside text-yellow-700 text-sm space-y-1">
                    {% for warning in warnings %}
                    <li>{{ warning }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Success message - shown when validation passes -->
            {% if not load_error and not errors %}
            <div class="mb-4 p-4 bg-green-50 border-l-4 border-green-500">
                <div class="font-medium text-green-800">Validation Passed</div>
                <p class="text-green-700 text-sm">Ready for approval.</p>
            </div>
            {% endif %}

            <!--
                JSON EDITOR FORM
                Single form with two submit buttons:
                - Validate: POSTs to /validate for re-validation
                - Approve: POSTs to /approve to save and move files
            -->
            <form id="review-form" method="post">
                <!-- Hidden field to preserve filename across form submissions -->
                <input type="hidden" name="filename" value="{{ filename }}">

                <label for="json-editor" class="block text-sm font-medium text-gray-700 mb-2">
                    JSON Content (editable)
                </label>
                <!-- Monospace textarea for JSON editing -->
                <textarea
                    id="json-editor"
                    name="json_text"
                    class="json-textarea w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                    spellcheck="false"
                >{{ json_text }}</textarea>

                <!-- Action buttons -->
                <div class="mt-4 flex space-x-3">
                    <!-- Validate button - re-validates without saving -->
                    <button
                        type="submit"
                        formaction="/validate"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    >
                        <!-- Checkmark circle icon -->
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Validate
                    </button>

                    <!--
                        Approve button - saves to approved/ and moves to processed/
                        Disabled when there are errors or load errors
                    -->
                    <button
                        type="submit"
                        formaction="/approve"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 {% if errors or load_error %}opacity-50 cursor-not-allowed{% endif %}"
                        {% if errors or load_error %}disabled{% endif %}
                    >
                        <!-- Checkmark icon -->
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Approve
                    </button>
                </div>
            </form>
        </div>

        <!--
            IMAGE PREVIEW SECTION
            Shows the source topology image if available.
            Supports two formats:
            - image_data_url: Base64 data URL (embedded in JSON)
            - image_path: Path to image file (served from /image/)
        -->
        {% if image_url %}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">Source Image</h2>
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <img src="{{ image_url }}" alt="Topology source image" class="w-full h-auto">
            </div>
        </div>
        {% endif %}
    </div>

    <!-- RIGHT COLUMN: Read-only data tables for nodes and links -->
    <div class="space-y-4">

        <!--
            NODES TABLE
            Displays all nodes from the topology in a scrollable table.
            Shows key fields: ID, Label, Type, Management IP, Vendor
            Type field uses color-coded badges per device type.
        -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">
                Nodes
                <span class="ml-2 text-sm font-normal text-gray-500">({{ nodes|length }} total)</span>
            </h2>

            {% if nodes %}
            <!-- Scrollable container with max height -->
            <div class="overflow-x-auto max-h-80 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <!-- Sticky header stays visible when scrolling -->
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Label</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mgmt IP</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for node in nodes %}
                        <tr class="hover:bg-gray-50">
                            <!-- Node ID in monospace font -->
                            <td class="px-3 py-2 whitespace-nowrap font-mono text-xs">{{ node.id }}</td>
                            <td class="px-3 py-2 whitespace-nowrap">{{ node.label }}</td>
                            <!--
                                Device type with color-coded badge:
                                router=blue, switch=green, firewall=red,
                                server=purple, workstation=orange, cloud=cyan, unknown=gray
                            -->
                            <td class="px-3 py-2 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded-full
                                    {% if node.type == 'router' %}bg-blue-100 text-blue-800
                                    {% elif node.type == 'switch' %}bg-green-100 text-green-800
                                    {% elif node.type == 'firewall' %}bg-red-100 text-red-800
                                    {% elif node.type == 'server' %}bg-purple-100 text-purple-800
                                    {% elif node.type == 'workstation' %}bg-orange-100 text-orange-800
                                    {% elif node.type == 'cloud' %}bg-cyan-100 text-cyan-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ node.type }}
                                </span>
                            </td>
                            <!-- Management IP in monospace, dash if not set -->
                            <td class="px-3 py-2 whitespace-nowrap font-mono text-xs">{{ node.mgmt_ip or '-' }}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-xs">{{ node.vendor or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500 text-sm">No nodes found.</p>
            {% endif %}
        </div>

        <!--
            LINKS TABLE
            Displays all links (connections) between nodes.
            Shows: Source node, Source port, arrow, Target node, Target port
        -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">
                Links
                <span class="ml-2 text-sm font-normal text-gray-500">({{ links|length }} total)</span>
            </h2>

            {% if links %}
            <!-- Scrollable container with max height -->
            <div class="overflow-x-auto max-h-64 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <!-- Sticky header -->
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Source Port</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase"></th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Target</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Target Port</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for link in links %}
                        <tr class="hover:bg-gray-50">
                            <!-- Source node ID -->
                            <td class="px-3 py-2 whitespace-nowrap font-mono text-xs">{{ link.source }}</td>
                            <!-- Source port, dash if not specified -->
                            <td class="px-3 py-2 whitespace-nowrap text-xs">{{ link.source_port or '-' }}</td>
                            <!-- Arrow icon indicating connection direction -->
                            <td class="px-3 py-2 text-center text-gray-400">
                                <svg class="h-4 w-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </td>
                            <!-- Target node ID -->
                            <td class="px-3 py-2 whitespace-nowrap font-mono text-xs">{{ link.target }}</td>
                            <!-- Target port, dash if not specified -->
                            <td class="px-3 py-2 whitespace-nowrap text-xs">{{ link.target_port or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500 text-sm">No links found.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
