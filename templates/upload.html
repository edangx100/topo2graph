<!--
    Upload template - allows users to upload topology images for extraction.
    Supports drag-and-drop or file picker.
    On submit, triggers vision model extraction and redirects to review page.
-->
{% extends "base.html" %}

{% block title %}Upload Image - Topo2Graph{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Back navigation -->
    <div class="mb-4">
        <a href="/" class="inline-flex items-center text-indigo-600 hover:text-indigo-800">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Back to list
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Upload Topology Image</h1>
        <p class="text-gray-600 mb-6">
            Upload a network topology diagram to extract nodes and links using AI vision.
        </p>

        <!-- Error message -->
        {% if error %}
        <div class="mb-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700">
            <div class="font-medium">Error</div>
            <p>{{ error }}</p>
        </div>
        {% endif %}

        <!-- Success message -->
        {% if success %}
        <div class="mb-4 p-4 bg-green-50 border-l-4 border-green-500 text-green-700">
            <div class="font-medium">Success</div>
            <p>{{ success }}</p>
        </div>
        {% endif %}

        <!-- Upload form -->
        <form action="/extract" method="post" enctype="multipart/form-data" id="upload-form">
            <!-- Drag and drop zone -->
            <div
                id="drop-zone"
                class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
            >
                <!-- Upload icon -->
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>

                <p class="mt-4 text-gray-600">
                    <span class="font-medium text-indigo-600">Click to upload</span> or drag and drop
                </p>
                <p class="mt-1 text-sm text-gray-500">
                    PNG, JPG, JPEG, GIF, or WEBP
                </p>

                <!-- Hidden file input -->
                <input
                    type="file"
                    name="image"
                    id="file-input"
                    accept=".png,.jpg,.jpeg,.gif,.webp"
                    class="hidden"
                    required
                />
            </div>

            <!-- Selected file preview -->
            <div id="file-preview" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <div>
                            <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                            <p id="file-size" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <button type="button" id="clear-file" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <!-- Image thumbnail preview -->
                <div id="image-preview-container" class="mt-3 hidden">
                    <img id="image-preview" class="max-h-48 rounded border border-gray-200" />
                </div>
            </div>

            <!-- Model selection -->
            <div class="mt-4">
                <label for="model" class="block text-sm font-medium text-gray-700 mb-2">Vision Model</label>
                <select
                    name="model"
                    id="model"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                    <option value="8b" selected>Qwen3-VL-8B-Instruct - simple diagrams, &lt;~10 devices</option>
                    <option value="32b">Qwen3-VL-32B-Instruct  - complex diagrams, ~20 devices</option>
                </select>
                <p class="mt-1 text-xs text-gray-500">32B is slower but handles complex diagrams better</p>
            </div>

            <!-- Submit button -->
            <div class="mt-6">
                <button
                    type="submit"
                    id="submit-btn"
                    class="w-full inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <span id="btn-text">Extract Topology</span>
                </button>
            </div>
        </form>

        <!-- Processing indicator (shown during extraction) -->
        <div id="processing" class="hidden mt-6 text-center">
            <div class="inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-800 rounded-lg">
                <!-- Spinner -->
                <svg class="animate-spin h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Extracting topology... This may take a moment.</span>
            </div>
        </div>

        <!-- Info section -->
        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-sm font-medium text-gray-800 mb-2">Tips for best results</h3>
            <ul class="text-sm text-gray-600 space-y-1">
                <li>- Please ensure that images are under 100KB in size</li>
                <li>- The 8B model performs more consistently when using smaller images.</li>
                <li>- Use clear, high-resolution topology diagrams</li>
                <li>- Ensure device labels are readable</li>
                <li>- Simple layouts with straight lines work best</li>
                <li>- Avoid hand-drawn sketches or dense rack diagrams</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // DOM elements
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const clearFile = document.getElementById('clear-file');
    const submitBtn = document.getElementById('submit-btn');
    const uploadForm = document.getElementById('upload-form');
    const processing = document.getElementById('processing');
    const btnText = document.getElementById('btn-text');
    const imagePreview = document.getElementById('image-preview');
    const imagePreviewContainer = document.getElementById('image-preview-container');

    // Click to open file picker
    dropZone.addEventListener('click', () => fileInput.click());

    // Handle file selection
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showFilePreview(e.target.files[0]);
        }
    });

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Update file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]);
            fileInput.files = dataTransfer.files;
            showFilePreview(files[0]);
        }
    });

    // Show file preview
    function showFilePreview(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        filePreview.classList.remove('hidden');
        dropZone.classList.add('hidden');
        submitBtn.disabled = false;

        // Show image thumbnail
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    // Clear file selection
    clearFile.addEventListener('click', () => {
        fileInput.value = '';
        filePreview.classList.add('hidden');
        dropZone.classList.remove('hidden');
        submitBtn.disabled = true;
        imagePreviewContainer.classList.add('hidden');
    });

    // Format file size
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Show processing state on submit
    uploadForm.addEventListener('submit', () => {
        submitBtn.disabled = true;
        btnText.textContent = 'Processing...';
        processing.classList.remove('hidden');
    });
</script>
{% endblock %}
